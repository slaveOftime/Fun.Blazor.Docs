<h2 id="how-does-this-work">How does this work?</h2>
<p>Fun.Blazor provides a series of delegates for Blazor to handle. For example, when you write:</p>
<pre><code class="language-fsharp">let demo =
    div {
        class' &quot;cool&quot;
    }
</code></pre>
<p>This code essentially becomes:</p>
<pre><code class="language-fsharp">let demo =
    NodeRenderFragment(fun comp builder index -&gt;  // delegate
        builder.OpenElement(index, &quot;div&quot;)
        bulder.AddAttribute(index + 1, &quot;class&quot;, &quot;cool&quot;)
        builer.CloseElement()
        index + 2
    )

type NodeRenderFragment = delegate of root: IComponent * builder: RenderTreeBuilder * sequence: int -&gt; int
</code></pre>
<p>In essence, you have created a delegate that will be passed to a component, which will manage the rendering or building of the DOM tree. This approach is similar to what the Razor engine would generate in the C# world.</p>
<p>Components can be created using <code>adaptiview</code>, <code>html.inject</code>, etc. These components are normal Blazor components that inherit from <code>ComponentBase</code>.</p>
<h2 id="considerations-before-using-fun.blazor">Considerations before using Fun.Blazor:</h2>
<p>There are a few things to keep in mind:</p>
<ol>
<li><p>The F# compiler has performance issues with intellisense for some large computation expressions (CEs). It is better to keep single CE blocks and files small, or use sequences like <code>seq</code>, <code>list</code>, or <code>array</code> with <code>childContent</code> for better intellisense. <a href="https://github.com/dotnet/fsharp/issues/14429">issue tracked in fsharp repo</a>.</p>
<p>There are some tests in <a href="https://github.com/albertwoo/CEPerfDemo">here</a>, in summary, below are some recommend ways for better build time performance (but it can reduce runtime performance because we cannot inline and need to allocate memory on head for creating array or list)</p>
<ul>
<li><p>The best result is <strong>list-with-local-vars</strong> for multiple child items</p>
<pre><code class="language-fsharp">let demo1 = div {
    class' &quot;font-bold&quot;
    &quot;demo1&quot;
}

let demo2 = div {
    class' &quot;font-bold&quot;
    &quot;demo2&quot;
}

let comp = div {
    style { color &quot;red&quot; }
    childContent [| // ðŸ‘Œâœ…
        demo1
        demo2
    |]
}
</code></pre>
</li>
<li><p><strong>nested-one</strong> is ok</p>
<pre><code class="language-fsharp">let comp = div {
    class' &quot;font-bold&quot;
    div { // ðŸ‘Œâœ…
        class' &quot;font-bold&quot;
        div { &quot;demo1&quot; }
    }
}
</code></pre>
</li>
<li><p><strong>nested-one-one</strong> is not ok (bad for build perf)</p>
<pre><code class="language-fsharp">let comp = div {
    class' &quot;font-bold&quot;
    div {
        class' &quot;font-bold&quot;
        div { // â›”ðŸ™…
            class' &quot;font-bold&quot;
            div { &quot;demo1&quot; }
        }
    }
}
</code></pre>
</li>
<li><p>inline local vars is not ok (bad for build perf)</p>
<pre><code class="language-fsharp">let comp = div {
    class' &quot;font-bold&quot;
    let temp = div { // â›”ðŸ™…
        class' &quot;font-bold&quot;
        &quot;demo1&quot;
    }
    temp
}
</code></pre>
</li>
</ul>
</li>
<li><p>Hot-reload</p>
<p>The default templates provide limited hot-reload support. Too many files can slow down the hot-reload process, so for best results, add <code>// hot-reload</code> at the top of files you want to enable hot-reload for. For more information, see the <a href="https://www.slaveoftime.fun/blog/d959e36a-f4fe-4a10-88af-5e738633db0f?title=%20Hot-reload%20in%20Fun.Blazor">Hot-reload in Fun.Blazor</a> blog post or <a href="https://slaveoftime.github.io/Fun.Blazor.Docs/?doc=/Hot%20Reload">document</a>.</p>
</li>
<li><p>Attribute, items position in CE</p>
<p>When using a <code>ref</code> or <code>renderMode</code> attribute etc., you should place it like below, because blazor treat them very special and can only add them after other attributes:</p>
<pre><code class="language-fsharp">div {
    attributes ...
    ref (fun x -&gt; ()) // âœ…
    childContent [| ... |]
}
</code></pre>
<p>Or:</p>
<pre><code class="language-fsharp">div {
    attributes ...
    ref (fun x -&gt; ()) // âœ…
    div { 1 }
}
</code></pre>
</li>
</ol>
<h2 id="benchmarks">Benchmarks</h2>
<p>BenchmarkDotNet v0.13.12, Windows 11 (10.0.22631.3007/23H2/2023Update/SunValley3)
12th Gen Intel Core i7-12700H, 1 CPU, 20 logical and 14 physical cores
.NET SDK 8.0.100
[Host]     : .NET 8.0.1 (8.0.123.58001), X64 RyuJIT AVX2 DEBUG
DefaultJob : .NET 8.0.1 (8.0.123.58001), X64 RyuJIT AVX2</p>
<table>
<thead>
<tr>
<th>Method</th>
<th style="text-align: right;">Mean</th>
<th style="text-align: right;">Error</th>
<th style="text-align: right;">StdDev</th>
<th style="text-align: right;">Ratio</th>
<th style="text-align: right;">RatioSD</th>
<th style="text-align: right;">Gen0</th>
<th style="text-align: right;">Allocated</th>
<th style="text-align: right;">Alloc Ratio</th>
</tr>
</thead>
<tbody>
<tr>
<td>RenderWithRazorCSharp</td>
<td style="text-align: right;">235.1 ns</td>
<td style="text-align: right;">3.50 ns</td>
<td style="text-align: right;">3.27 ns</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.0296</td>
<td style="text-align: right;">376 B</td>
<td style="text-align: right;">1.00</td>
</tr>
<tr>
<td>RenderWithBolero</td>
<td style="text-align: right;">533.4 ns</td>
<td style="text-align: right;">8.54 ns</td>
<td style="text-align: right;">7.57 ns</td>
<td style="text-align: right;">2.27</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">0.1173</td>
<td style="text-align: right;">1480 B</td>
<td style="text-align: right;">3.94</td>
</tr>
<tr>
<td>RenderWithFunBlazorInlineCE</td>
<td style="text-align: right;">426.7 ns</td>
<td style="text-align: right;">5.13 ns</td>
<td style="text-align: right;">4.80 ns</td>
<td style="text-align: right;">1.82</td>
<td style="text-align: right;">0.04</td>
<td style="text-align: right;">0.0577</td>
<td style="text-align: right;">728 B</td>
<td style="text-align: right;">1.94</td>
</tr>
<tr>
<td>RenderWithFunBlazorArray</td>
<td style="text-align: right;">650.6 ns</td>
<td style="text-align: right;">12.18 ns</td>
<td style="text-align: right;">11.39 ns</td>
<td style="text-align: right;">2.77</td>
<td style="text-align: right;">0.08</td>
<td style="text-align: right;">0.1478</td>
<td style="text-align: right;">1856 B</td>
<td style="text-align: right;">4.94</td>
</tr>
</tbody>
</table>
