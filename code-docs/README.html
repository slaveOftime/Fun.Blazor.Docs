<h1>Fun.Blazor <a href="https://www.nuget.org/packages/Fun.Blazor"><img src="https://img.shields.io/nuget/vpre/Fun.Blazor" alt="Nuget" /></a></h1>
<blockquote>
<p>This project is under developing and in beta, api are expected to be changed, please use it carefully. Also please check the <a href="#pitfalls">Pitfalls</a> before you try.</p>
</blockquote>
<h2>Table of contents</h2>
<ul>
<li><a href="#docs">Docs</a></li>
<li><a href="#what-you-can-get-with-this-project">What you can get from this project</a></li>
<li><a href="#please-check-the-samples-for-quick-start">Templates</a></li>
<li><a href="#main-projects">Main projects</a></li>
<li><a href="#pitfalls">Pitfalls</a></li>
<li><a href="#code-structure-example">Code structure example</a></li>
<li><a href="#benchmark">Benchmark</a></li>
<li><a href="#migrate-from-v1">Migration from v1</a></li>
</ul>
<h2>What</h2>
<p>This is a project to make F# developer to write blazor easier.</p>
<p>It is based on <a href="https://github.com/fsbolero/Bolero">bolero</a> and  <a href="https://github.com/alfonsogarciacaro/Feliz.Engine">Feliz.Engine</a> before. \
Now <strong>(in V2)</strong> the dependency of bolero is removed to make it lighter. <strong>Feliz style is deprecated</strong> because it will cause more allocation and render loop than CE style, also it is too verbose as a DSL.</p>
<h2>Docs</h2>
<p>Now the docs are only written as an experimental playground and simple introduction, so it is not well organized. A new design may needed.</p>
<p><a href="https://funblazor.slaveoftime.fun">Server side docs</a></p>
<p><a href="https://slaveoftime.github.io/Fun.Blazor.Docs/">Wasm side docs (may take a while to load)</a></p>
<h2>What you can get with this project?</h2>
<ol>
<li>Use F# ‚ù§Ô∏èüòä for blazor</li>
<li>Template, computation expression style DSL for internal and third party blazor libraries</li>
<li>Dependency injection (html.inject)</li>
<li><a href="https://github.com/fsprojects/FSharp.Data.Adaptive">Adaptive</a> model (adaptiview) (<strong>recommend</strong>), <a href="https://github.com/elmish/elmish">elmish</a> model (html.elmish), <a href="https://github.com/fsprojects/FSharp.Control.Reactive">obervable</a> model (html.watch)</li>
</ol>
<h2>Please check the samples for quick start</h2>
<p><a href="https://github.com/slaveOftime/Slaveoftime.Site
https://github.com/slaveOftime/Fun.Blazor.Samples">https://github.com/slaveOftime/Slaveoftime.Site
https://github.com/slaveOftime/Fun.Blazor.Samples</a></p>
<p>Below version may not be updated, please check here <a href="https://www.nuget.org/packages/Fun.Blazor.Templates"><img src="https://img.shields.io/nuget/vpre/Fun.Blazor.Templates" alt="Nuget" /></a></p>
<pre><code class="language-shell">dotnet new --install Fun.Blazor.Templates::2.0.0-beta013
</code></pre>
<h2>Main projects</h2>
<ol>
<li>
<p><strong>Fun.Blazor</strong>: help you to use basic dom DSL and state management helpers.</p>
<pre><code class="language-fsharp">let demo =
    adaptiview(){ // this is more recommend than html.watch and html.elmish
        let! v, setValue = FSharp.Data.Adaptive.cval(1).WithSetter()
        button {
            onclick (fun _ -&gt; setValue (v + 1))
            "Increase"
        }
        div {
            style { color "red" }
            $"value = {v}"
        }
    }
</code></pre>
</li>
<li>
<p><strong>Fun.Blazor.HtmlTemplate</strong>: help you to convert plain string to dom tree. And with VSCode + Ionide-fsharp + Highlight HTML/SQL templates you can get embeded intellicense. You can check more detail in <a href="https://github.com/slaveOftime/Fun.Blazor.Samples/tree/main/templates/MinimalBlazorWASMAppWithShoelaceAndTailwind">shoelacejs + tailwind demo</a></p>
<pre><code class="language-fsharp">// If there is no argument for formatable string then it will be very efficient. So it is better to always keep static part and dynamic part in different places.
let staticPart =
    Static.html """
        &lt;div style="color: hotpink;"&gt;Congratulations! You made it ‚ù§Ô∏è&lt;/div&gt;
    """

// The performance will not be good as CE DSL for initial start. Because it need to parse at runtime and cache for next usage.
let dynamicPart =
    adaptiview(){
        let! v, setValue = FSharp.Data.Adaptive.cval(1).WithSetter()
        Template.html $"""
            &lt;div&gt;
                {staticPart}
                {v}
                &lt;button onclick={fun _ -&gt; setValue (v + 1)}&gt;&lt;/button&gt;
            &lt;/div&gt;
        """
    }
</code></pre>
</li>
</ol>
<ol>
<li>
<p><strong>Fun.Blazor.Cli</strong>: support hot-reload, help you to generate CE style binding automatically for any blazor third party libraries.</p>
<p><a href="https://funblazor.slaveoftime.fun/cli-usage">Docs for how to use it</a></p>
<p><a href="https://github.com/slaveOftime/Fun.Blazor.Samples/tree/main/templates/BlazorWASMAppWithMudBlazor">Samples for using MudBlazor</a></p>
<pre><code class="language-shell">dotnet tool install --global Fun.Blazor.Cli --version 2.0.0-beta023
</code></pre>
</li>
</ol>
<pre><code>```fsharp
open Fun.Blazor
open MudBlazor

let alertDemo =
    MudCard'() {
        MudAlert'() {
            Icon Icons.Filled.AccessAlarm
            "This is the way"
        }
    }
```
</code></pre>
<h2>Pitfalls</h2>
<ol>
<li>
<p>FSharp compiler cannot handle large computation expression. It is better to make simple CE block smaller and single file smaller. Or use sequence like seq/list/array with childContent:</p>
<pre><code class="language-fsharp">div {
    onclick ignore
    other attrs
    childContent [ ‚úÖ it is recommended to use this when you got more than one child items
        div { "hi" }
        ...a lot of child items
    ]
}
</code></pre>
<p>Instead of below:</p>
<pre><code class="language-fsharp">div {
    onclick ignore
    other attrs
    div { "hi" }
    ...a lot of child items  ‚ùå
}
</code></pre>
</li>
<li>
<p>Hot-reload</p>
<p>Now the default templates contain limited hot-reload support.
It is also very slow to have too much file to be hot-reloaded, so you need to add <strong>// hot-reload</strong> at the top of the file you want to enable hot-reload.
For more detail you can check my blog post <a href="https://www.slaveoftime.fun/blog/d959e36a-f4fe-4a10-88af-5e738633db0f?title=%20Hot-reload%20in%20Fun.Blazor">Hot-reload in Fun.Blazor</a>.<br />
Or check the document.</p>
</li>
<li>
<p>ref position</p>
<p>When you want to use ref attribute, you need to put it like below</p>
<pre><code class="language-fsharp">div {
    some other attibutes
    ref ... ‚úÖ
    childContent [ ... ]
}
</code></pre>
</li>
</ol>
<h2>Code structure example</h2>
<p>This project support multiple pattern for state management. From my experience it is not good to use elmish for your whole project. Because the performance and state share concern, also sometimes it feels a little verbose.</p>
<p>You can try this:</p>
<p><strong>Db</strong><br />
<strong>Domain</strong><br />
<strong>Services</strong><br />
<strong>UI</strong><br />
|--- Stores.fs // contains shared store or global store</p>
<pre><code class="language-fsharp">    type IShareStore with // scoped for the session in blazor server mode
        member store.IsDark = store.CreateCVal("IsDark", true)

    type IGlobalStore with // Singleton store, shared for all
        ...
</code></pre>
<p>|--- Hooks.fs // standalone UI logic</p>
<pre><code class="language-fsharp">    type IComponentHook with
        member hook.TryLoadPosts(page) =
            task {
                ...
            }

        member hook.UseSettingsForm() =
            hook
                .UseAdaptiveForm({| Name = "foo"; ... |})
                .AddValidators(...)
                .AddValidators(...)
</code></pre>
<p>|--- Controls.fs // Some small shared controls<br />
|--- Comp1.fs // Your business component</p>
<pre><code class="language-fsharp">    // Make your fragment smaller, so you can compose it in cleaner way and get better inline optimization, hot-reload speeding and intellisense performance
    let private fragment1 = div {...}

    let private fragment2 (shareStore: IShareStore) =
        adaptiview {
            let! isDark, setIsDark = shareStore.IsDark.WithSetter()   
            div { ... } 
        }

    // or use elmish if you like
    let private fragment3 = html.elmish (init, update, view)

    let comp1 =
        html.inject (fun (svc1, shareStore: IShareStore, ...) -&gt;
            div {
                childContent [
                    fragment1
                    fragment2 shareStore
                    fragment3
                ]
            }
        )
</code></pre>
<p>|--- Comp2.Hooks.fs // in case you have large component, or you can even create separate folder for the whole component<br />
|--- Comp2.Control1.fs // manage large control which is only for your business Comp2<br />
|--- Comp2.fs // The entry for your comp2<br />
|--- App.fs // compose your components or pages</p>
<pre><code class="language-fsharp">let private routes =
    html.route [
        routeCi "/page1" comp1
        routeAny comp2
    ]

let app =
    div {
        header
        routes
        footer
    }
</code></pre>
<p>|--- Index.fs // if you are using blazor server mode, you need to have this. You can check the template.<br />
|--- Startup.fs</p>
<blockquote>
<p>You can check repo <a href="https://github.com/slaveOftime/Slaveoftime.Site">https://github.com/slaveOftime/Slaveoftime.Site</a> as a reference for those practical tips.</p>
</blockquote>
<h2>Benchmark</h2>
<table>
<thead>
<tr class="header">
<th><p>Method</p></th>
<th align="right"><p>Mean</p></th>
<th align="right"><p>Error</p></th>
<th align="right"><p>StdDev</p></th>
<th align="right"><p>Median</p></th>
<th align="right"><p>Gen 0</p></th>
<th align="right"><p>Gen 1</p></th>
<th align="right"><p>Allocated</p></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>BuildRenderTreeWithCSharp</p></td>
<td align="right"><p>387.0 ns</p></td>
<td align="right"><p>6.54 ns</p></td>
<td align="right"><p>6.12 ns</p></td>
<td align="right"><p>388.2 ns</p></td>
<td align="right"><p>0.0610</p></td>
<td align="right"><p>-</p></td>
<td align="right"><p>384 B</p></td>
</tr>
<tr class="even">
<td><p>BuildRenderTreeWithBolero</p></td>
<td align="right"><p>2,097.9 ns</p></td>
<td align="right"><p>41.77 ns</p></td>
<td align="right"><p>112.20 ns</p></td>
<td align="right"><p>2,057.3 ns</p></td>
<td align="right"><p>0.6943</p></td>
<td align="right"><p>0.0038</p></td>
<td align="right"><p>4,368 B</p></td>
</tr>
<tr class="odd">
<td><p>BuildRenderTreeWithCE</p></td>
<td align="right"><p>808.5 ns</p></td>
<td align="right"><p>16.01 ns</p></td>
<td align="right"><p>39.26 ns</p></td>
<td align="right"><p>794.1 ns</p></td>
<td align="right"><p>0.1745</p></td>
<td align="right"><p>-</p></td>
<td align="right"><p>1,096 B</p></td>
</tr>
<tr class="even">
<td><p>BuildRenderTreeWithTemplate</p></td>
<td align="right"><p>3,817.9 ns</p></td>
<td align="right"><p>84.19 ns</p></td>
<td align="right"><p>248.24 ns</p></td>
<td align="right"><p>3,769.4 ns</p></td>
<td align="right"><p>0.7668</p></td>
<td align="right"><p>0.0076</p></td>
<td align="right"><p>4,832 B</p></td>
</tr>
<tr class="odd">
<td><p>BuildRenderTreeWithFeliz</p></td>
<td align="right"><p>2,616.5 ns</p></td>
<td align="right"><p>51.97 ns</p></td>
<td align="right"><p>123.52 ns</p></td>
<td align="right"><p>2,618.0 ns</p></td>
<td align="right"><p>1.2474</p></td>
<td align="right"><p>0.0114</p></td>
<td align="right"><p>7,832 B</p></td>
</tr>
<tr class="even">
<td><p>BuildRenderTreeWithCEFeliz</p></td>
<td align="right"><p>1,456.7 ns</p></td>
<td align="right"><p>34.21 ns</p></td>
<td align="right"><p>100.32 ns</p></td>
<td align="right"><p>1,452.7 ns</p></td>
<td align="right"><p>0.6180</p></td>
<td align="right"><p>0.0038</p></td>
<td align="right"><p>3,880 B</p></td>
</tr>
</tbody>
</table>

<table>
<thead>
<tr class="header">
<th><p>Method</p></th>
<th align="right"><p>Mean</p></th>
<th align="right"><p>Error</p></th>
<th align="right"><p>StdDev</p></th>
<th align="right"><p>Gen 0</p></th>
<th align="right"><p>Allocated</p></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>BuildStyleWithCssBuilder</p></td>
<td align="right"><p>375.8 ns</p></td>
<td align="right"><p>7.87 ns</p></td>
<td align="right"><p>22.44 ns</p></td>
<td align="right"><p>0.1211</p></td>
<td align="right"><p>760 B</p></td>
</tr>
<tr class="even">
<td><p>BuildStyleWithFeliz</p></td>
<td align="right"><p>693.1 ns</p></td>
<td align="right"><p>13.05 ns</p></td>
<td align="right"><p>13.96 ns</p></td>
<td align="right"><p>0.2918</p></td>
<td align="right"><p>1,832 B</p></td>
</tr>
</tbody>
</table>

<h2>Migrate from V1</h2>
<ul>
<li>
<p>For all the internal dom element like div, we should change</p>
<pre><code class="language-fsharp">div() {}
</code></pre>
<p>to</p>
<pre><code class="language-fsharp">div {}
</code></pre>
</li>
<li>
<p>For server side, we should add nuget packages: Fun.Blazor.Server</p>
<p>AddFunBlazor is changed to AddFunBlazorServer \
MapFallbackToBolero is changed to MapFunBlazor</p>
</li>
<li>
<p>For wasm side, we should add nuget packages: Fun.Blazor.Wasm</p>
<p>AddFunBlazor is changed to AddFunBlazorWasm \
AddFunBlazorNode is changed to AddFunBlazor</p>
</li>
</ul>
